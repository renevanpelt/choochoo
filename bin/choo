#!/usr/bin/env ruby

require 'colorize'




def aggregate_database_schema_configuration
<<-EOF


# This should not be configuration, therefore it explicitly is until the 
# framework allows the user to manage their databases using migrations

AggregateRecord::Schema.define do

  self.verbose = true

end
EOF
end

def gemfile
<<-EOF

source 'https://rubygems.org'
gem 'choochoo', :git => 'https://github.com/renevanpelt/choochoo.git', :branch => 'master'

EOF
end

def mainrb
<<-EOF


require 'active_record'
require 'pusher'
require 'yaml'
require 'choo'


AggregateRecord = ActiveRecord
EventRecord     = ActiveRecord

EventRecord::Base.establish_connection(adapter: 'sqlite3', database: 'THISNEEDSTOCHANGE.db')
AggregateRecord::Base.establish_connection(adapter: 'sqlite3', database: 'THISNEEDSTOCHANGE_2.db')

# The aggregate database config are part of app config now but
# will be managed by migrations later on.

require './config/aggregate_database.rb'

# The event database however doesn't have to be managed by the
# user using migrations. 

EventRecord::Schema.define do
  self.verbose = true

  create_table(:Choo_events, force: true) do |t|
    t.string      :event_type,       null: false
    t.text        :serialized_payload,          null: false
    t.string      :aggregate_id,     null: false
    t.datetime    :created_at,       null: false
    t.integer     :version,          null: false
    t.index [:aggregate_id, :version], unique: true
  end

end





class AggregateRecord::Base


  # notify is a silly function that was needed in the 
  # very early stages of development of the framework
  # and might be handy for W-M to see what happens.
  # Can be removed.

  after_create :notify

  def notify
    puts "#{self.class} created"
  end

  def to_param
    uuid
  end
end

application = Choo::Application.new

require 'haml'
require 'sinatra'

before do
   headers 'Access-Control-Allow-Origin' => '*', 
            'Access-Control-Allow-Methods' => ['OPTIONS', 'GET', 'POST', 'PATCH']  
end

EOF
end





def create_directory(directory)

  FileUtils.mkdir_p directory
  puts "Directory with name '#{directory}' created".green
end

def create_file(filename, content)

  File.open(filename, 'w') do |file|
    file.write content
  end
  puts "File with name '#{filename}' created".green


end

arguments = ARGV
command = arguments.first

# 
# The new command
# 

if command == "new"
  app_name = arguments[1]
  if app_name
    if File.directory?(app_name)
      puts "Directory with name '#{app_name}' already exists".red
    else
      create_directory(app_name)
      create_directory("#{app_name}/config")
      create_file("#{app_name}/config/aggregate_database.rb", aggregate_database_schema_configuration)
      create_file("#{app_name}/seeds.rb", "")
      create_file("#{app_name}/Gemfile", gemfile)
      create_file("#{app_name}/main.rb", mainrb)
    end
  else
    puts "Please supply a name for your app like this: choo new [APP NAME]".red
  end


# 
# The server command
# 

elsif command == "server"

  `rerun 'main.rb'`

else
  puts "Command '#{command}' is unknown. 'new' and 'server' are the only available command at this time.".red
end


